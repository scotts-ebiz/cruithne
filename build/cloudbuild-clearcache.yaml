steps:
- name: 'gcr.io/cloud-builders/kubectl'
  entrypoint: 'bash'
  args:
    - '-eEuo'
    - 'pipefail'
    - '-c'
    - |-
      gcloud container clusters get-credentials --zone "$_CLOUDSDK_COMPUTE_ZONE" "$_CLOUDSDK_CONTAINER_CLUSTER"

      magento_pods=$(kubectl get pod --no-headers -o=custom-columns=NAME:.metadata.name -l=app=$_APP_LABELS)

      export CLEAN_COMMAND="bin/magento cache:clean"
      export FLUSH_COMMAND="bin/magento cache:flush"

      for pod in $$magento_pods
      do 
        kubectl exec $$pod -- $$CLEAN_COMMAND
        kubectl exec $$pod -- $$FLUSH_COMMAND
      done    


timeout: 3600s
