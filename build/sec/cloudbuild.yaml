# Build instructions for Google Cloud Build 
# Runs Docker and deploys new image to test
# Will need to modify to be enviornment agnostic

steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:$SHORT_SHA', '--build-arg', 'IMAGE=${_PRIMER_REPO}', '--cache-from', 'gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:latest', '.']
  dir: 'build/sec/'
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:$SHORT_SHA', 'gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:latest']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:$SHORT_SHA']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:latest']
- name: 'gcr.io/cloud-builders/kubectl'
  args: 
    - 'set'
    - 'image'
    - 'statefulset/${_WORKLOAD}'
    - '${_CONTAINER_REPO_NAME}=gcr.io/$PROJECT_ID/${_CONTAINER_REPO_NAME}:$SHORT_SHA'
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=${_CLOUDSDK_COMPUTE_ZONE}'
    - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLOUDSDK_CONTAINER_CLUSTER}'

# kubectl rolling-update test-magento --image=gcr.io/ecommerce-platform-211419/test-magento:20190207211618
# kubectl set image statefulset stateful-magento-test magento-stateful=gcr.io/ecommerce-platform-211419/magento-stateful:2a51b2a

timeout: 6000s
