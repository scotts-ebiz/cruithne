sudo: required
dist: xenial
language: php
group: edge

env:
  #global environmental variables control magento instal parameters
  #see also hosts in addons.
  global:
  - LOCAL_URL=https://store.cruithne.test
  - ADMIN_EMAIL=nicholas.spencer@scotts.com
  - ADMIN_FIRST=Chase
  - ADMIN_LAST=Spencer
  - ADMIN_USERNAME=admin
  - ADMIN_PASSWORD=password
  - DB_NAME=cruithne

php:
- 7.1

addons:
  apt:
    packages:
    - mysql-server
    - mysql-client
  hosts:
    - store.cruithne.test

matrix:
  fast_finish: true

cache:
  apt: true
  directories:
  - $HOME/.composer/cache
  - $HOME/.nvm
  - $HOME/node_modules
  - $HOME/yarn.lock
  - "vendor"

notifications:
  slack: smg-developers:vcBHeIcYxtoP1Pnv7nuT6ZGv

before_install:
- export DEBIAN_FRONTEND=noninteractive
- sudo apt-get -y update
- sudo DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical apt-get -q -y -o "Dpkg::Options::=--force-confdef" -o "Dpkg::Options::=--force-confold" upgrade
- sudo DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical apt-get -q -y -o "Dpkg::Options::=--force-confdef" -o "Dpkg::Options::=--force-confold" dist-upgrade
- sudo apt-get -y update
- sudo apt-get -y install apache2
# Enable aliases for non-interactive shell.
- shopt -s expand_aliases
- composer selfupdate
# Disable xdebug.
- phpenv config-rm xdebug.ini
# Enable $_ENV variables in PHP.
- echo 'variables_order = "EGPCS"' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
# Ensure that always_populate_raw_post_data PHP setting: Not set to -1 does not happen.
- echo "always_populate_raw_post_data = -1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
- sudo git config --global user.name "Travis-CI"
- sudo git config --global user.email "noreply@travis-ci.org"

# MySQL Configuration
#- sudo apt-get install mysql-server-5.7 -y
#- sudo apt-get install mysql-client-5.7 -y
- mysql -h 127.0.0.1 -e "create database cruithne;"
- mysql -h 127.0.0.1 -e "grant all on cruithne.* to 'varien'@'%' identified by 'j7K9u3Lm2wA6';"
- sed  '/skip-external-locking/a wait_timeout=30000' /etc/mysql/my.cnf

# PHP configuration.
# disable xdebug for perf
- add-apt-repository ppa:ondrej/php
- sudo apt-get -y update
- sudo apt-get -y install php7.1 libapache2-mod-php7.1 php7.1-common php7.1-gd php7.1-mysql php7.1-curl php7.1-intl php7.1-xsl php7.1-mbstring php7.1-zip php7.1-bcmath php7.1-iconv php7.1-soap php7.1-mcrypt
- sed -i "s/;date\.timezone =$/date\.timezone = 'America\/New_York'/" /etc/php/7.1/cli/php.ini
- sed -i "s/;date\.timezone =$/date\.timezone = 'America\/New_York'/" /etc/php/7.1/apache2/php.ini
- sed -i 's/;opcache\.save_comments/opcache\.save_comments/' /etc/php/7.1/cli/php.ini
- sed -i 's/;opcache\.save_comments/opcache\.save_comments/' /etc/php/7.1/apache2/php.ini
- sed -i 's/short_open_tag = Off/short_open_tag = On/' /etc/php/7.1/cli/php.ini
- sed -i 's/short_open_tag = Off/short_open_tag = On/' /etc/php/7.1/apache2/php.ini
- sed -i 's/memory_limit = [0-9]+M/memory_limit = 1G/' /etc/php/7.1/apache2/php.ini
- phpenmod mcrypt
- echo '' > ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini
- phpenv config-add config/ci/travis.php.ini
- phpenv rehash

# get latest composer
- composer selfupdate

# Clone repo
- git clone git@github.com:scotts-ebiz/cruithne.git /var/www/

# Configure Apache
- rm /etc/apache2/sites-available/000-default.conf
- cp $TRAVIS_BUILD_DIR/environment/config/000-default.conf /etc/apache2/sites-available/000-default.conf
- sudo service apache2 restart

install:
# Install composer dependencies
- composer install

before_script:
# run installation command using evn variables set above
- php bin/magento setup:install --admin-email "$ADMIN_EMAIL" --admin-firstname "$ADMIN_FIRST" --admin-lastname "$ADMIN_LAST" --admin-password "$ADMIN_PASSWORD" --admin-user "$ADMIN_USERNAME" --backend-frontname admin --base-url "$LOCAL_URL" --db-host 127.0.0.1 --db-name "$DB_NAME" --db-user root --session-save files --use-rewrites 1 --use-secure 0 -vvv

#script:
## the ci:build takes about 20 mins with db triggering the 10 minute travis inactivity timeout - use travis_wait to avoid error.
#- travis_wait 30 blt -Dbehat.run-server=true -Dcreate_alias=false -Dbehat.launch-phantom=true ci:build:validate:test -Dblt.verbose=true

#deploy:
#- provider: script
#  script: blt deploy -Ddeploy.commitMsg="Automated commit by Travis CI for Build ${TRAVIS_BUILD_ID}" -Ddeploy.branch="${TRAVIS_BRANCH}-build"
#  skip_cleanup: true
#  on:
#    branch: develop
#    php: 7.1
#- provider: script
#  script: blt deploy -Ddeploy.commitMsg="Automated commit by Travis CI for Build ${TRAVIS_BUILD_ID}" -Ddeploy.branch="${TRAVIS_BRANCH}-build"
#  skip_cleanup: true
#  on:
#    branch: test
#    php: 7.1
#- provider: script
#  script: blt deploy -Ddeploy.commitMsg="Automated commit by Travis CI for Build ${TRAVIS_BUILD_ID}" -Ddeploy.branch="${TRAVIS_BRANCH}-build"
#  skip_cleanup: true
#  on:
#    branch: master
#    php: 7.1
